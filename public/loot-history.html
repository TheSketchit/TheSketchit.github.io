<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WoW Loot History</title>
  <link rel="stylesheet" href="../css/styles.css">
  <link rel="stylesheet" href="../css/embers.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
</head>
<body>
  <div class="top-banner">
    <div class="container">
      <button onclick="goToGame()">Back</button>
      <div id="auth-container">
        <button onclick="goToLogin()">Login</button>
      </div>
    </div>
  </div>

  <canvas id="emberCanvas"></canvas>
  <div class="heat-effect"></div>

  <div class="container">
    <h1>Loot History Tracker</h1>

    <div id="tracker-container" style="display:none;">
      <label for="raidDate" id="raidDateLabel">Raid Date:</label>
      <input type="date" id="raidDate"><br><br>

      <textarea id="csvInput" rows="10" cols="100"></textarea><br>
      <button onclick="processCSV()" id="saveLootButton">Save Loot History</button>

      <div class="navigation-container">
        <div class="chevron-navigation">
          <div class="chevron" onclick="selectRaid('Sunken Temple')">Sunken Temple</div>
          <div class="chevron" onclick="selectRaid('World Bosses')">World Bosses</div>
          <div class="chevron" onclick="selectRaid('Onyxia')">Onyxia</div>
          <div class="chevron" onclick="selectRaid('Molten Core')">Molten Core</div>
          <div class="chevron" onclick="selectRaid('Blackwing Lair')">Blackwing Lair</div>
          <div class="chevron" onclick="selectRaid('Zul Gurub')">Zul Gurub</div>
          <div class="chevron" onclick="selectRaid('Crystal Vale')">Crystal Vale</div>
          <div class="chevron" onclick="selectRaid('Lil AQ')">Lil AQ</div>
          <div class="chevron" onclick="selectRaid('Big AQ')">Big AQ</div>
          <div class="chevron" onclick="selectRaid('Nightmare Grove')">Nightmare Grove</div>
        </div>
        <div class="dropdown">
          <button class="dropbtn">History Raid Dates</button>
          <div class="dropdown-content" id="viewRaidDate"></div>
        </div>
      </div>

      <div id="filterIndicator" style="display:none;"></div>
      <button onclick="clearFilter()" id="clearFilterButton" style="display:none;">Clear Filter</button>

      <div class="parchment-table-container">
        <div class="parchment-table-top">
          <div class="parchment-table-top-left"></div>
          <div class="parchment-table-top-middle"></div>
          <div class="parchment-table-top-right"></div>
        </div>
        <div class="parchment-table-middle">
          <div class="parchment-table-left"></div>
          <div class="parchment-table-content">
            <table id="lootTable">
              <thead>
                <tr>
                  <th onclick="sortTable('Item')">Item</th>
                  <th onclick="sortTable('ItemID')">ItemID</th>
                  <th onclick="sortTable('Winner')">Winner</th>
                  <th onclick="sortTable('SR')">SR</th>
                  <th onclick="sortTable('OS')">OS</th>
                  <th onclick="sortTable('Date')">Date</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="parchment-table-right"></div>
        </div>
        <div class="parchment-table-bottom">
          <div class="parchment-table-bottom-left"></div>
          <div class="parchment-table-bottom-middle"></div>
          <div class="parchment-table-bottom-right"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Firebase config
    var firebaseConfig = {
      apiKey: "AIzaSyByH17o2XNgMensJhFivtsYNlzpjVIRP3E",
      authDomain: "wowsr-9ec27.firebaseapp.com",
      projectId: "wowsr-9ec27",
      storageBucket: "wowsr-9ec27.appspot.com",
      messagingSenderId: "1037521583710",
      appId: "1037521583710:web:290e85c6bde4e047337ecf",
      databaseURL: "https://wowsr-9ec27-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);

    let isGuest = true;
    let currentFilter = null;
    let currentSort = { column: 'Date', direction: 'desc' };
    let selectedRaid = null;

    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        isGuest = false;
        document.getElementById('auth-container').innerHTML = '<button onclick="signOut()">Sign Out</button>';
      } else {
        isGuest = true;
        document.getElementById('auth-container').innerHTML = '<button onclick="goToLogin()">Login</button>';
      }
      onLoginStateChange();
    });

    function onLoginStateChange() {
      if (isGuest) {
        document.getElementById('raidDateLabel').style.display = 'none';
        document.getElementById('raidDate').style.display = 'none';
        document.getElementById('csvInput').style.display = 'none';
        document.getElementById('saveLootButton').style.display = 'none';
      } else {
        document.getElementById('raidDateLabel').style.display = 'block';
        document.getElementById('raidDate').style.display = 'block';
        document.getElementById('csvInput').style.display = 'block';
        document.getElementById('saveLootButton').style.display = 'inline-block';
      }
      document.getElementById('tracker-container').style.display = 'block';
      displayStoredData();
    }

    function signOut() {
      firebase.auth().signOut()
        .then(() => console.log('Signed out'))
        .catch(error => console.error('Sign out error:', error));
    }

    function processCSV() {
      const csvInput = document.getElementById('csvInput').value;
      const raidDate = document.getElementById('raidDate').value;
    
      if (!selectedRaid || !raidDate) {
        alert('Please select a raid and a raid date.');
        return;
      }
    
      Papa.parse(csvInput, {
        header: false,
        complete: function(results) {
          const data = results.data;
          data.forEach(row => {
            saveToFirebase(row);
          });
        }
      });
    }


    function saveToFirebase(row) {
      if (!row || row.length < 6) return;
      const record = {
        Date: row[0] || '',
        Item: row[1] || '',
        ItemID: row[2] || '',
        Winner: row[3] || '',
        SR: row[4] || '',
        OS: row[5] || ''
      };
    
      firebase.database().ref(`lootHistoryData/${selectedRaid}`)
        .push(record)
        .catch(e => console.error('Error writing record:', e));
    }


    // Display data
    function displayStoredData() {
      if (!selectedRaid) {
        document.querySelector('#lootTable tbody').innerHTML = '';
        return;
      }
      const ref = firebase.database().ref(`lootHistoryData/${selectedRaid}`);
      ref.once('value')
        .then(snapshot => {
          let data = snapshot.val() || {};
          let rows = Object.entries(data).map(([key, obj]) => ({ key, ...obj }));
          if (currentFilter) {
            rows = rows.filter(r => r[currentFilter.column] === currentFilter.value);
          }
          sortData(rows);
          renderTable(rows);
          populateRaidDateDropdown(rows);
        })
        .catch(e => console.error('Error fetching loot history:', e));
    }

    function renderTable(rows) {
      const tbody = document.querySelector('#lootTable tbody');
      tbody.innerHTML = '';
    
      rows.forEach(row => {
        const tr = document.createElement('tr');
        createCell(tr, row.Item, row.ItemID);
        createCell(tr, row.ItemID);
        createCell(tr, row.Winner);
        createCell(tr, row.SR);
        createCell(tr, row.OS);
        createCell(tr, row.Date);
        tbody.appendChild(tr);
      });

      if (typeof $WowheadPower !== 'undefined') {
        $WowheadPower.refreshLinks();
      }
    }

    function createCell(tr, value, itemID = '') {
      const td = document.createElement('td');
      if (itemID && td.cellIndex === 0) {
        // If we want a Wowhead link in the first cell
        const link = document.createElement('a');
        link.href = `https://wowhead.com/classic/item=${itemID}`;
        link.target = '_blank';
        link.textContent = value;
        td.appendChild(link);
      } else {
        td.textContent = value;
      }
      // Click to filter
      td.onclick = () => filterByColumn(getColumnKey(td.cellIndex), value);
      tr.appendChild(td);
    }

    function getColumnKey(index) {
      // Table columns: 0=Item,1=ItemID,2=Winner,3=SR,4=OS,5=Date
      switch (index) {
        case 0: return 'Item';
        case 1: return 'ItemID';
        case 2: return 'Winner';
        case 3: return 'SR';
        case 4: return 'OS';
        case 5: return 'Date';
      }
    }

    // Sorting
    function sortData(rows) {
      rows.sort((a, b) => {
        const col = currentSort.column;
        if (col === 'Date') {
          // Date sort
          return currentSort.direction === 'asc'
            ? new Date(a.Date) - new Date(b.Date)
            : new Date(b.Date) - new Date(a.Date);
        } else {
          // String or numeric comparison
          const valA = (a[col] || '').toString();
          const valB = (b[col] || '').toString();
          if (currentSort.direction === 'asc') return valA.localeCompare(valB);
          else return valB.localeCompare(valA);
        }
      });
    }

    function sortTable(column) {
      if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.column = column;
        currentSort.direction = 'asc';
      }
      displayStoredData();
    }

    // Filter
    function filterByColumn(column, value) {
      currentFilter = { column, value };
      displayStoredData();
      document.getElementById('clearFilterButton').style.display = 'inline-block';
      updateFilterIndicator();
    }

    function clearFilter() {
      currentFilter = null;
      displayStoredData();
      document.getElementById('clearFilterButton').style.display = 'none';
      updateFilterIndicator();
    }

    // Filter indicator
    function updateFilterIndicator() {
      const el = document.getElementById('filterIndicator');
      if (!currentFilter) {
        el.style.display = 'none';
      } else {
        el.textContent = `Filtered by ${currentFilter.column}: ${currentFilter.value}`;
        el.style.display = 'block';
      }
    }

    // Raid selection
    function selectRaid(raid) {
      selectedRaid = raid;
      currentFilter = null;
      currentSort = { column: 'Date', direction: 'desc' };

      document.querySelectorAll('.chevron').forEach(ch => ch.classList.remove('active'));
      const el = document.querySelector(`.chevron[onclick="selectRaid('${raid}')"]`);
      if (el) el.classList.add('active');

      displayStoredData();
    }

    // Populate date dropdown from loaded rows
    function populateRaidDateDropdown(rows) {
      const dropdown = document.getElementById('viewRaidDate');
      dropdown.innerHTML = '';
      if (!rows || !rows.length) return;
      const uniqueDates = [...new Set(rows.map(r => r.Date))].sort((a, b) => new Date(b) - new Date(a));
      uniqueDates.forEach(date => {
        const div = document.createElement('div');
        div.className = 'dropdown-item';
        div.textContent = date;
        div.onclick = () => filterByColumn('Date', date);
        dropdown.appendChild(div);
      });
    }

    // Navigation
    function goToLogin() {
      window.location.href = '/login.html';
    }

    window.onload = () => {
      onLoginStateChange();
    };

  </script>
  <script>const whTooltips = {colorLinks: true, iconizeLinks: true, renameLinks: true};</script>
  <script src="https://wow.zamimg.com/js/tooltips.js"></script>
  <script src="../js/embers.js"></script>
</body>
</html>

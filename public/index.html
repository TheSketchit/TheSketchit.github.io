<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WoW Soft Reserve Loot Tracker</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <h1>WoW Soft Reserve Loot Tracker</h1>

  <div id="auth-container">
    <h2>Sign In</h2>
    <label for="email">Email:</label>
    <input type="email" id="email" required><br><br>
    <label for="password">Password:</label>
    <input type="password" id="password" required><br><br>
    <button onclick="signIn()">Sign In</button>
    <button onclick="guestLogin()">Guest Login</button>
    <button onclick="signOut()">Sign Out</button>
  </div>

  <div id="tracker-container" style="display:none;">
    <div id="duplicate-message-container"></div> <!-- Container for warning message -->
    <label for="raidDate" id="raidDateLabel">Raid Date:</label>
    <input type="date" id="raidDate"><br><br>
    <textarea id="csvInput" rows="10" cols="100"></textarea><br>
    <button onclick="processCSV()" id="saveLootButton">Save Loot</button>
    <button onclick="calculateSRs()" id="calculateSRsButton">Calculate SRs</button>

    <div class="chevron-navigation">
      <div class="chevron" onclick="selectRaid('Sunken Temple')">Sunken Temple</div>
      <div class="chevron" onclick="selectRaid('Kazzak')">Kazzak</div>
      <div class="chevron" onclick="selectRaid('Azuregos')">Azuregos</div>
      <div class="chevron" onclick="selectRaid('Onyxia')">Onyxia</div>
      <div class="chevron" onclick="selectRaid('Molten Core')">Molten Core</div>
      <!-- Add more raids as needed -->
    </div>

    <div class="dropdown">
      <button class="dropbtn">Soft-Reserves Raid Dates</button>
      <div class="dropdown-content" id="viewRaidDate">
        <!-- Options will be populated dynamically -->
      </div>
    </div>

    <table id="lootTable">
      <thead>
        <tr>
          <th onclick="sortTable('Item')">Item</th>
          <th onclick="sortTable('From')">From</th>
          <th onclick="sortTable('Name')">Name</th>
          <th onclick="sortTable('Class')">Class</th>
          <th onclick="sortTable('Spec')">Spec</th>
          <th onclick="sortTable('RaidDate')">Raid Date</th>
          <th onclick="sortTable('SRPoints')">SR Points</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
  <script>
    // Your web app's Firebase configuration
    var firebaseConfig = {
      apiKey: "AIzaSyByH17o2XNgMensJhFivtsYNlzpjVIRP3E",
      authDomain: "wowsr-9ec27.firebaseapp.com",
      projectId: "wowsr-9ec27",
      storageBucket: "wowsr-9ec27.appspot.com",
      messagingSenderId: "1037521583710",
      appId: "1037521583710:web:290e85c6bde4e047337ecf",
      databaseURL: "https://wowsr-9ec27-default-rtdb.firebaseio.com"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    // Get a reference to the database service
    const db = firebase.database();

    let isGuest = false;
    let selectedRaid = 'Sunken Temple'; // Default selected raid

    // Handle user authentication state
    firebase.auth().onAuthStateChanged(user => {
      onLogin();
    });

    function onLogin() {
      if (isGuest || firebase.auth().currentUser) {
        document.getElementById('auth-container').style.display = 'none';
        document.getElementById('tracker-container').style.display = 'block';
        populateRaidDateDropdown();
        if (isGuest) {
          document.getElementById('raidDateLabel').style.display = 'none';
          document.getElementById('raidDate').style.display = 'none';
          document.getElementById('csvInput').style.display = 'none';
          document.getElementById('saveLootButton').style.display = 'none';
          document.getElementById('calculateSRsButton').style.display = 'none';
        }
      } else {
        document.getElementById('auth-container').style.display = 'block';
        document.getElementById('tracker-container').style.display = 'none';
      }
    }

    function signIn() {
      var email = document.getElementById('email').value;
      var password = document.getElementById('password').value;
      firebase.auth().signInWithEmailAndPassword(email, password)
        .then(userCredential => {
          var user = userCredential.user;
          console.log('Signed in:', user);
        })
        .catch(error => {
          console.error('Error signing in:', error);
          alert('Error signing in: ' + error.message);
        });
    }

    function guestLogin() {
      isGuest = true;
      onLogin();
    }

    function signOut() {
      isGuest = false;
      firebase.auth().signOut()
        .then(() => {
          console.log('User signed out');
        })
        .catch(error => {
          console.error('Error signing out:', error);
        });
    }

    function processCSV() {
      const csvInput = document.getElementById('csvInput').value;
      const raidDate = document.getElementById('raidDate').value;
      const raid = selectedRaid;

      if (!raidDate || !raid) {
        alert('Please select a raid and a raid date.');
        return;
      }

      Papa.parse(csvInput, {
        header: true,
        complete: function(results) {
          const data = results.data;
          data.forEach(row => {
            row.RaidDate = raidDate;
            row['SRPoints'] = 1;
          });
          saveToFirebase(data, raid);
        }
      });
    }

    function saveToFirebase(data, raid) {
      const user = firebase.auth().currentUser;
      if (user) {
        const lootRef = firebase.database().ref(`raidLootData/${raid}`);
        let duplicateEntries = [];

        lootRef.once('value').then(snapshot => {
          const existingData = snapshot.val() || {};
          const existingEntries = Object.values(existingData);

          data.forEach(row => {
            const duplicate = existingEntries.some(existing => 
              existing.Name === row.Name && existing.RaidDate === row.RaidDate
            );

            if (!duplicate) {
              lootRef.push(row)
                .then(() => {
                  console.log('Document successfully written!');
                })
                .catch(error => {
                  console.error('Error writing document: ', error);
                });
            } else {
              duplicateEntries.push(row);
            }
          });

          if (duplicateEntries.length > 0) {
            displayDuplicateMessage(duplicateEntries);
          } else {
            alert('Data saved successfully!');
          }
        }).catch(error => {
          console.error('Error reading existing data: ', error);
        });
      } else {
        alert('You must be signed in to save data.');
      }
    }

    function displayDuplicateMessage(duplicateEntries) {
      const container = document.getElementById('duplicate-message-container');
      container.innerHTML = ''; // Clear previous messages
    
      const noticeDiv = document.createElement('div');
      noticeDiv.className = 'notice';
      const closeButton = document.createElement('span');
      closeButton.className = 'closebtn';
      closeButton.innerHTML = '&times;';
      closeButton.onclick = () => noticeDiv.style.display = 'none';
      noticeDiv.appendChild(closeButton);
    
      const message = document.createElement('p');
      message.innerHTML = '<strong>The following rows were not submitted due to duplicate data being found:</strong>';
    
      const scrollBox = document.createElement('div');
      scrollBox.className = 'scroll-box';
    
      duplicateEntries.forEach(entry => { // Show all entries
        const row = document.createElement('p');
        row.textContent = `Name: ${entry.Name}, Item: ${entry.Item}, RaidDate: ${entry.RaidDate}`;
        scrollBox.appendChild(row);
      });
    
      noticeDiv.appendChild(message);
      noticeDiv.appendChild(scrollBox);
      container.appendChild(noticeDiv);
    }

    function displayStoredData() {
      const lootRef = firebase.database().ref(`raidLootData/${selectedRaid}`);
      lootRef.once('value', (snapshot) => {
        const data = snapshot.val();
        console.log("Fetched data from Firebase:", data); // Debugging line
        const dataArray = data ? Object.values(data) : [];
        console.log("Data array to be displayed:", dataArray); // Debugging line
        displayData(dataArray);
      }).catch(error => {
        console.error('Error fetching data: ', error); // Debugging line
      });
    }

    function displayData(data) {
      const tableBody = document.getElementById('lootTable').getElementsByTagName('tbody')[0];
      tableBody.innerHTML = '';
      data.forEach(row => {
        console.log("Displaying row:", row); // Debugging line
        const tr = document.createElement('tr');
        ['Item', 'From', 'Name', 'Class', 'Spec', 'RaidDate', 'SRPoints'].forEach(key => {
          const td = document.createElement('td');
          if (key === 'Item') {
            const a = document.createElement('a');
            a.href = `https://wowhead.com/classic/item=${row.ItemId}`;
            a.target = '_blank';
            a.className = 'item-row notranslate d-block q1 q3';
            a.innerHTML = `<ins></ins><del></del></span><span class="itemlink-text">${row[key]}</span></a>`;
            td.appendChild(a);
          } else {
            td.textContent = row[key];
          }
          td.style.cursor = 'pointer';
          td.onclick = () => filterByColumn(key, row[key]);
          tr.appendChild(td);
        });
        tableBody.appendChild(tr);
      });
    }

    function calculateSRs() {
      const lootRef = firebase.database().ref(`raidLootData/${selectedRaid}`);
      lootRef.once('value', (snapshot) => {
        const data = snapshot.val();
        let storedData = data ? Object.entries(data) : [];
        let playerItemModifiers = {};
        let uniqueData = {};
        let duplicateEntries = [];
    
        let updates = {};
    
        // Process stored data and organize it for SR calculation
        storedData.forEach(([key, row]) => {
          const uniqueKey = row.Name.toLowerCase().trim() + '_' + row.Item + '_' + row.Raid;
          if (uniqueData[uniqueKey]) {
            uniqueData[uniqueKey].push({ key, row });
          } else {
            uniqueData[uniqueKey] = [{ key, row }];
          }
        });
    
        // Calculate SR Points for each unique entry
        Object.values(uniqueData).forEach(entries => {
          // Sort entries by RaidDate in ascending order
          entries.sort((a, b) => new Date(a.row.RaidDate) - new Date(b.row.RaidDate));
    
          // Assign SR points based on sorted order
          entries.forEach((entry, index) => {
            entry.row['SRPoints'] = index + 1;
            updates[`/raidLootData/${entry.row.Raid}/${entry.key}`] = entry.row;
          });
        });
    
        // Update Firebase with recalculated SR Points
        firebase.database().ref().update(updates)
          .then(() => {
            alert('SR Points recalculated successfully!');
            displayStoredData();
          })
          .catch(error => {
            console.error('Error updating SR Points: ', error);
          });
      });
    }


    // Populate the dropdown menu with raid dates
    function populateRaidDateDropdown() {
      const lootRef = firebase.database().ref(`raidLootData/${selectedRaid}`);
      lootRef.once('value', (snapshot) => {
        const data = snapshot.val();
        const raidDates = new Set();
        if (data) {
          Object.values(data).forEach(row => {
            raidDates.add(row.RaidDate);
          });
        }
        const raidDateDropdown = document.getElementById('viewRaidDate');
        raidDateDropdown.innerHTML = ''; // Clear existing options
        raidDates.forEach(date => {
          const option = document.createElement('div');
          option.className = 'dropdown-item';
          option.textContent = date;
          option.onclick = () => displaySRsByRaidDate(date, selectedRaid);
          raidDateDropdown.appendChild(option);
        });
      }).catch(error => {
        console.error('Error fetching raid dates: ', error);
      });
    }

    // Display SRs by selected raid date
    function displaySRsByRaidDate(date, raid) {
      const lootRef = firebase.database().ref(`raidLootData/${raid}`);
      lootRef.once('value', (snapshot) => {
        const data = snapshot.val();
        const filteredData = data ? Object.values(data).filter(row => row.RaidDate === date) : [];
        displayData(filteredData);
      }).catch(error => {
        console.error('Error fetching data: ', error);
      });
    }

    function filterByColumn(column, value) {
      const lootRef = firebase.database().ref(`raidLootData/${selectedRaid}`);
      lootRef.once('value', (snapshot) => {
        const data = snapshot.val();
        let storedData = data ? Object.values(data) : [];
        const filteredData = storedData.filter(row => row[column] === value);
        displayData(filteredData);
      });
    }

    function sortTable(column) {
      const lootRef = firebase.database().ref(`raidLootData/${selectedRaid}`);
      lootRef.once('value', (snapshot) => {
        const data = snapshot.val();
        let storedData = data ? Object.values(data) : [];
        storedData.sort((a, b) => (a[column] > b[column]) ? 1 : ((b[column] > a[column]) ? -1 : 0));
        displayData(storedData);
      });
    }

    function selectRaid(raid) {
      selectedRaid = raid;
      document.querySelectorAll('.chevron').forEach(chevron => {
        chevron.classList.remove('active');
      });
      document.querySelector(`.chevron[onclick="selectRaid('${raid}')"]`).classList.add('active');
      populateRaidDateDropdown();
      displayStoredData();
    }

  </script>
  <script>const whTooltips = {colorLinks: true, iconizeLinks: true, renameLinks: true};</script>
  <script src="https://wow.zamimg.com/js/tooltips.js"></script>
</body>
</html>
